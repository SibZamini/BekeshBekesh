{{define "lobby-create-page"}}
<!DOCTYPE html>
<html dir="rtl" lang="fa">

<head>
    <title>Bekesh Bekesh</title>
    <meta charset="UTF-8"/>
    {{template "font-decl" .}}
    <link rel="stylesheet" type="text/css" href="{{.RootPath}}/resources/base.css"/>
    <link rel="stylesheet" type="text/css" href="{{.RootPath}}/resources/lobby_create.css"/>
    <link rel="icon" type="image/png" href="{{.RootPath}}/resources/favicon.png"/>
</head>

<body>
    <div class="content-wrapper">
    <noscript><span class="noscript">{{.Translation.Get "requires-js"}}</span></noscript>

    <div class="tab-header">
        <label for="create-lobby-tab-button">
            <input id="create-lobby-tab-button" class="custom-check-or-radio tab-button"
                type="radio" onclick="openTab('create-lobby')" name="tab" checked>
            <div class="tab-label">üè† {{.Translation.Get "create-lobby"}}</div>
        </label>
        <label for="join-lobby-tab-button">
            <input id="join-lobby-tab-button" class="custom-check-or-radio tab-button"
                type="radio" onclick="openTab('join-lobby')" name="tab">
            <div class="tab-label">üîç {{.Translation.Get "join-lobby"}}</div>
        </label>
    </div>

    <div id="create-lobby" class="tab-content">
        <div class="center-container">
            <div class="content-container">
                {{if .Errors}}
                    <div class="error-list">
                        {{.Translation.Get "input-contains-invalid-data"}}
                        <ul>
                            {{range .Errors}}
                                <li>{{.}}</li>
                            {{end}}
                        </ul>
                        <br/>
                        {{.Translation.Get "please-fix-invalid-input"}}
                    </div>

                {{end}}
                <form id="lobby-create" class="create-room-form" action="{{.RootPath}}/ssrCreateLobby" method="POST" onsubmit="return saveAndCreate()">
                    <label class="form-label">üë§ {{.Translation.Get "username"}}</label>
                    <input class="input-item" name="username" id="username-id"/>

                    <label class="form-label">üìö {{.Translation.Get "word-language"}}</label>
                    <select class="input-item" style="font-family: yekan,serif" name="language">
                        {{$language := .Language}}
                        {{range $k, $v := .Languages}}
                            <option value="{{$k}}" {{if eq $k $language}}selected="selected"{{end}}>{{$v}}</option>
                        {{end}}
                    </select>

                    <label class="form-label">‚è±Ô∏è {{.Translation.Get "drawing-time-setting"}}</label>
                    <input class="input-item" type="number" name="drawing_time" min="{{.MinDrawingTime}}"
                    max="{{.MaxDrawingTime}}" value="{{.DrawingTime}}"/>

                    <label class="form-label">üîÑ {{.Translation.Get "rounds-setting"}}</label>
                    <input class="input-item" type="number" name="rounds" min="{{.MinRounds}}" max="{{.MaxRounds}}"
                    value="{{.Rounds}}"/>

                    <label class="form-label">üë• {{.Translation.Get "max-players-setting"}}</label>
                    <input class="input-item" type="number" name="max_players" min="{{.MinMaxPlayers}}"
                    max="{{.MaxMaxPlayers}}" value="{{.MaxPlayers}}"/>

                    <label class="form-label">üåê {{.Translation.Get "public-lobby-setting"}}</label>
                    <input class="input-item" type="checkbox" name="public" value="true"
                        {{if eq .Public "true"}}checked{{end}}/>

                    <label class="form-label">üìù {{.Translation.Get "words-per-round"}}</label>
                    <input class="input-item" type="number" name="words-per-round" min="{{.MinWordsPerRound}}"
                           max="{{.MaxWordsPerRound}}" value="{{.WordsPerRound}}"/>

                    <label class="form-label">üì° {{.Translation.Get "players-per-ip-limit-setting"}}</label>
                    <input class="input-item" type="number" name="clients_per_ip_limit" min="{{.MinClientsPerIPLimit}}"
                    max="{{.MaxClientsPerIPLimit}}" value="{{.ClientsPerIPLimit}}"/>

                    <label class="form-label">üó≥Ô∏è {{.Translation.Get "enable-votekick-setting"}}</label>
                    <input class="input-item" type="checkbox" name="enable_votekick" value="true"
                    {{if eq .EnableVotekick "true"}}checked{{end}}/>

                    <label class="form-label form-label-row-start">‚úèÔ∏è {{.Translation.Get "custom-words"}}</label>
                    <textarea class="input-item form-textarea form-field-wide" name="custom_words"
                    placeholder="{{.Translation.Get "custom-words-info"}}">{{.CustomWords}}</textarea>

                    <label class="form-label form-label-row-start">üé≤ {{.Translation.Get "custom-words-chance-setting"}}</label>
                    <div class="range-wrapper form-field-wide">
                        <span>0%</span>
                        <input type="range" name="custom_words_chance" min="1" max="100" value="{{.CustomWordsChance}}">
                        <span>100%</span>
                    </div>

                    <button id="create-lobby-submit" type="submit" form="lobby-create" class="create-room-btn">
                        üéÆ {{.Translation.Get "create-lobby"}}
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="join-lobby" class="tab-content">
        <div class="join-lobby-data">
            <div class="table-wrapper-wrapper">
                <button id="refresh-button" onclick="loadLobbyTable()">üîÑ {{.Translation.Get "refresh"}}</button>
                <div class="table-wrapper">
                    <table id="lobby-table">
                        <thead>
                            <tr>
                                <th>{{.Translation.Get "game-host"}}</th>
                                <th>{{.Translation.Get "word-language"}}</th>
                                <th>{{.Translation.Get "rounds-setting"}}</th>
                                <th>{{.Translation.Get "players"}}</th>
                                <th>{{.Translation.Get "drawing-time-setting"}}</th>
                                <th>{{.Translation.Get "custom-words"}}</th>
                            </tr>
                        </thead>
                        <tbody id="lobby-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="lobby-details">
                <span class="lobby-detail">{{.Translation.Get "word-language"}}:</span>
                <span id="wordpack-detail"></span>
                <span class="lobby-detail">{{.Translation.Get "rounds-setting"}}:</span>
                <span id="rounds-detail"></span>
                <span class="lobby-detail">{{.Translation.Get "players"}}:</span>
                <span id="players-detail"></span>
                <span class="lobby-detail">{{.Translation.Get "drawing-time-setting"}}:</span>
                <span id="drawing-time-detail"></span>
                <span class="lobby-detail">{{.Translation.Get "custom-words"}}:</span>
                <span id="custom-words-detail"></span>
                <span class="lobby-detail">{{.Translation.Get "enable-votekick-setting"}}:</span>
                <span id="votekicking-detail"></span>
                <span class="lobby-detail">{{.Translation.Get "players-per-ip-limit-setting"}}:</span>
                <span id="max-clients-ip-detail"></span>
                <button id="join-button" onclick="onJoin()" disabled class="join-btn">üö™ {{.Translation.Get "join-lobby"}}</button>
            </div>
        </div>
    </div>
        <a href="https://www.sibzaminigames.ir/">
        <img src="/resources/sibzamini.png"  id="sibzaminigames" title="SibZaminiGames"/>
        </a>
    {{template "footer" .}}
</div>

<script type="text/javascript">
    const FORM_STORAGE_KEY = 'bekeshCreateRoomSettings';
    const form = document.getElementById("lobby-create");

    function loadFormFromStorage() {
        let hasFormErrors = document.querySelector('.error-list') !== null;
        if (hasFormErrors) return;
        try {
            let saved = localStorage.getItem(FORM_STORAGE_KEY);
            if (saved) {
                let data = JSON.parse(saved);
                if (data.username) document.getElementById("username-id").value = data.username;
                if (data.language) { let el = form.querySelector('[name="language"]'); if (el) el.value = data.language; }
                if (data.drawing_time !== undefined) { let el = form.querySelector('[name="drawing_time"]'); if (el) el.value = data.drawing_time; }
                if (data.rounds !== undefined) { let el = form.querySelector('[name="rounds"]'); if (el) el.value = data.rounds; }
                if (data.max_players !== undefined) { let el = form.querySelector('[name="max_players"]'); if (el) el.value = data.max_players; }
                if (data.public !== undefined) { let el = form.querySelector('[name="public"]'); if (el) el.checked = data.public; }
                if (data.custom_words !== undefined) { let el = form.querySelector('[name="custom_words"]'); if (el) el.value = data.custom_words; }
                if (data.custom_words_chance !== undefined) { let el = form.querySelector('[name="custom_words_chance"]'); if (el) el.value = data.custom_words_chance; }
                if (data['words-per-round'] !== undefined) { let el = form.querySelector('[name="words-per-round"]'); if (el) el.value = data['words-per-round']; }
                if (data.clients_per_ip_limit !== undefined) { let el = form.querySelector('[name="clients_per_ip_limit"]'); if (el) el.value = data.clients_per_ip_limit; }
                if (data.enable_votekick !== undefined) { let el = form.querySelector('[name="enable_votekick"]'); if (el) el.checked = data.enable_votekick; }
            } else {
                if (localStorage.getItem("username")) document.getElementById("username-id").value = localStorage.getItem("username");
                if (localStorage.getItem("customWords")) { let el = form.querySelector('[name="custom_words"]'); if (el) el.value = localStorage.getItem("customWords"); }
            }
        } catch (e) {}
    }
    loadFormFromStorage();

    let lobbyTableLoaded = false;
    let lobbyTableBody = document.getElementById("lobby-table-body");
    let selectedLobby;
    
    let createLobbyTabButton = document.getElementById("create-lobby-tab-button");
    let joinLobbyTabButton = document.getElementById("join-lobby-tab-button");

    let joinButton = document.getElementById("join-button");

    let wordpackDetail = document.getElementById("wordpack-detail");
    let roundsDetail = document.getElementById("rounds-detail");
    let playersDetail = document.getElementById("players-detail");
    let drawingTimeDetail = document.getElementById("drawing-time-detail");
    let customWordsDetail = document.getElementById("custom-words-detail");
    let votekickingDetail = document.getElementById("votekicking-detail");
    let maxClientsIPDetail = document.getElementById("max-clients-ip-detail");

    function onJoin() {

        window.open("{{.RootPath}}/lobby?lobby_id=" + selectedLobby, "_self");
    }

    function loadLobbyTable() {
        lobbyTableLoaded = true;

        if (lobbyTableBody.childNodes.length > 0) {
            for (let i = lobbyTableBody.childNodes.length-1; i >= 0; i--) {
                lobbyTableBody.removeChild(lobbyTableBody.childNodes.item(i));
            }
        }

        fetch("{{.RootPath}}/v1/lobby")
            .then((response) => {
                return response.json();
            })
            .then((data) => {
                //Initially remove all data and disable join button, as we don't know
                //whether we'll have any data after fetching.
                showLobbyDetails(null);

                data.forEach(lobby => {
                    const host = document.createElement("td");
                    host.innerText = lobby.Host;

                    const wordpackCell = document.createElement("td");
                    wordpackCell.innerText = lobby.wordpack;
                    const roundsCell = document.createElement("td");
                    roundsCell.innerText = lobby.round + "/" + lobby.rounds;
                    const playersCell = document.createElement("td");
                    playersCell.innerText = lobby.playerCount + "/" + lobby.maxPlayers;
                    const drawingTimeCell = document.createElement("td");
                    drawingTimeCell.innerText = lobby.drawingTime.toString();
                    const customWordsCell = document.createElement("td");
                    customWordsCell.innerText = lobby.customWords ? '{{.Translation.Get "yes"}}' : '{{.Translation.Get "no"}}';

                    const newRow = document.createElement("tr");

                    newRow.appendChild(host);
                    newRow.appendChild(wordpackCell);
                    newRow.appendChild(roundsCell);
                    newRow.appendChild(playersCell);
                    newRow.appendChild(drawingTimeCell);
                    newRow.appendChild(customWordsCell);

                    lobbyTableBody.appendChild(newRow);

                    let clickHandler = function () {
                        lobbyTableBody.childNodes.forEach(row => {
                            row.setAttribute("selected", "false");
                        });
                        newRow.setAttribute("selected", "true");
                        selectedLobby = lobby.lobbyId;
                        showLobbyDetails(lobby);
                    };
                    newRow.addEventListener("click", clickHandler, false);
                });
            });
    }



    function saveFormToStorage() {
        try {
            let data = {
                username: document.getElementById("username-id")?.value || "",
                language: form.querySelector('[name="language"]')?.value || "",
                drawing_time: form.querySelector('[name="drawing_time"]')?.value || "",
                rounds: form.querySelector('[name="rounds"]')?.value || "",
                max_players: form.querySelector('[name="max_players"]')?.value || "",
                public: form.querySelector('[name="public"]')?.checked || false,
                custom_words: form.querySelector('[name="custom_words"]')?.value || "",
                custom_words_chance: form.querySelector('[name="custom_words_chance"]')?.value || "",
                "words-per-round": form.querySelector('[name="words-per-round"]')?.value || "",
                clients_per_ip_limit: form.querySelector('[name="clients_per_ip_limit"]')?.value || "",
                enable_votekick: form.querySelector('[name="enable_votekick"]')?.checked || false
            };
            localStorage.setItem(FORM_STORAGE_KEY, JSON.stringify(data));
        } catch (e) {}
    }

    function saveAndCreate() {
        saveFormToStorage();
        return true;
    }

    form.addEventListener('change', saveFormToStorage);
    form.addEventListener('input', function() { setTimeout(saveFormToStorage, 0); });

    function showLobbyDetails(lobby) {
        if (lobby === null) {
            wordpackDetail.innerText = "";
            roundsDetail.innerText = "";
            playersDetail.innerText = "";
            drawingTimeDetail.innerText = "";
            customWordsDetail.innerText = "";
            votekickingDetail.innerText = "";
            maxClientsIPDetail.innerText = "";
            joinButton.disabled = true;
        } else {
            wordpackDetail.innerText = lobby.wordpack;
            roundsDetail.innerText = lobby.round + "/" + lobby.rounds;
            playersDetail.innerText = lobby.playerCount + "/" + lobby.maxPlayers;
            drawingTimeDetail.innerText = lobby.drawingTime.toString();
            customWordsDetail.innerText = lobby.customWords ? '{{.Translation.Get "yes"}}' : '{{.Translation.Get "no"}}';
            votekickingDetail.innerText = lobby.votekick ? '{{.Translation.Get "yes"}}' : '{{.Translation.Get "no"}}';
            maxClientsIPDetail.innerText = lobby.maxClientsPerIp;
            joinButton.disabled = false;
        }
    }

    function openTab(tabId) {
        if (tabId === "join-lobby") {
            loadLobbyTable();
        }

        //Initially hide all tabs except for our target tab
        const tabs = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabs.length; i++) {
            tabs[i].style.display = "none";
        }

        //Show the newly selected tab.
        document.getElementById(tabId).style.display = "flex";
    }

    if(createLobbyTabButton.checked) {
        openTab('create-lobby');
    } else if (joinLobbyTabButton.checked) {
        openTab('join-lobby');
    }
</script>
</body>

</html>
{{end}}
